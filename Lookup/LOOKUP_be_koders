### vim:ft=zsh:foldmethod=marker
## koders.com source code search backend for lookup
## Copyright: 2009, Frank Terbeck <ft@bewatermyfriend.org>

LOOKUP_guard || return 1
[[ -n ${lookup_describe} ]] &&
    printf '%s' 'source code search via koders.com' &&
    return 0

local -a comp_args known_langs
local -A known_licences

known_langs=(
#{{{
    "ActionScript"
    "Ada"
    "ASP"
    "ASP.NET"
    "Assembler"
    "C"
    "C#"
    "C++"
    "Cobol"
    "ColdFusion"
    "Delphi"
    "Eiffel"
    "Erlang"
    "Fortran"
    "Java"
    "JavaScript"
    "JSP"
    "Lisp"
    "Lua"
    "Mathematica"
    "Matlab"
    "ObjectiveC"
    "Perl"
    "PHP"
    "Prolog"
    "Python"
    "Ruby"
    "Scheme"
    "Smalltalk"
    "SQL"
    "Tcl"
    "VB"
    "VB.NET"
#}}}
)

known_licences=(
#{{{
    AFL     'Academic Free Licence'
    AGPLv3  'Affero General Public Licence v3'
    AL20    'Apache Licence, Version 2.0'
    ASL     'Apache Software Licence'
    APSL    'Apple Public Source Licence'
    BSD     'Berkeley Software Distribution Licence'
    CPL     'Common Public Licence'
    EPL10   'Eclipse Public Licence v1.0'
    GTPL    'Globus Toolkit Public Licence'
    GPL     'GNU General Public Licence v1 v2 v3'
    LGPL    'GNU Lesser General Public Licence'
    IBMPL   'IBM Public Licence'
    IBMILA  'International Licence Agreement for Non-Warranted Programs'
    IOSL    'Intel Open Source Licence'
    MSCL    'Microsoft Community Licence'
    MSLCL   'Microsoft Limited Community Licence'
    MSPL    'Microsoft Permissive Licence'
    MSLPL   'Microsoft Limited Permissive Licence'
    MSRL    'Microsoft Reference Licence'
    MSVSSDK 'Microsoft Visual Studio SDK Licence'
    MITD    'MIT Derived Licence'
    MPL10   'Mozilla Public Licence Version 1.0'
    MPL11   'Mozilla Public Licence Version 1.1'
    NPL10   'Netscape Public Licence, Version 1.0'
    NPL11   'Netscape Public Licence, Version 1.1'
    OSL     'Open Software Licence'
    PHPL    'PHP Licence'
    CNRIPL  'Python Licence'
    PSFL    'Python Software Foundation Licence'
    SL      'Sleepycat Software Product Licence'
    SISSL   'Sun Industry Standards Source Licence'
    SPL     'Sun Public Licence'
    W3C     'W3C Software Licence'
    WXWLL   'wxWindows Library Licence'
    ZLL     'zlib/libpng Licence'
    ZPL     'Zope Public Licence'
#}}}
)

(( ${+functions[LOOKUP_help_$backend]} )) ||
function LOOKUP_help_${backend}() {
    printf 'usage: %s <query>\n' ${backend}
    printf '  -l <lang>     limit search to specific language\n'
    printf '  -L <licence>  limit search to specific licence\n'
}
LOOKUP_help ${backend} && return 0

if [[ -n ${lookup_complete} ]] ; then

    (( ${+functions[__lookup_${backend}_langs]} )) ||
    function __lookup_${backend}_langs() {
        _describe -t koders_langs 'known languages' known_langs
    }

    (( ${+functions[__lookup_${backend}_licences]} )) ||
    function __lookup_${backend}_licences() {
        local l
        local -a ls

        ls=()
        for l in ${(k)known_licences}; do
            ls+=("$l:${known_licences[$l]}")
        done
        _describe -t koders_licences 'known licences' ls
    }

    comp_args=(
        '-l[limit search to specific language]:language:__lookup_'${backend}'_langs'
        '-L[limit search to specific licence]:licence:__lookup_'${backend}'_licences'
        '*:source code search string:true'
    )

    _arguments -s -w -A '-*' ${comp_args} && return 0
    _message 'source code search string'
    return 0
fi

local lang licence
local -x QUERY

zstyle -s ":lookup:${lsys}:${backend}" default-lang    lang    || lang='*'
zstyle -s ":lookup:${lsys}:${backend}" default-licence licence || licence='*'

zparseopts -A opts -D l: L:
[[ -n ${opts[-l]} ]] && lang="${opts[-l]}"
[[ -n ${opts[-L]} ]] && licence="${opts[-L]}"

QUERY="$*"
LOOKUP_query_handler
if [[ -z ${QUERY} ]] ; then
    LOOKUP_help_${backend}
    return 1
fi

LOOKUP_encode -s -q
LOOKUP_browser "http://koders.com/default.aspx?s=${QUERY}&la=${lang}&li=${licence}"
return $?
